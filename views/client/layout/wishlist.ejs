<!doctype html>
<html lang="en">
<%- include('../partials/Header') %>
<style>
    /* Reuse package styling from tour-packages.ejs */
    .package-wrap .feature-image {
        width: 365px;
        height: 305px;
        overflow: hidden;
    }
    .package-wrap .feature-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center;
    }
    .review-area {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .review-text {
        font-size: 0.9rem;
        color: #555555;
    }
    .rating-start {
        font-size: 1rem;
        color: #ccc;
        display: inline-flex;
    }
    .rating-start i {
        margin: 0 2px;
    }
    .rating-start .filled {
        color: #f5c518;
    }
    .wishlist-remove {
        color: #dc3545;
        text-decoration: none;
        font-size: 0.9rem;
    }
    .wishlist-remove:hover {
        text-decoration: underline;
    }
</style>
<body>
    <%- include('../partials/Loader') %>
    <div id="page" class="full-page">
        <%- include('../partials/Navbar.ejs') %>
        <main id="content" class="site-main">
            <!-- Inner Banner -->
            <section class="inner-banner-wrap">
                <div class="inner-baner-container" style="background-image: url(/assets/images/inner-banner.jpg);">
                    <div class="container">
                        <div class="inner-banner-content">
                            <h1 class="inner-title">My Wishlist</h1>
                        </div>
                    </div>
                </div>
                <div class="inner-shape"></div>
            </section>
            <!-- Wishlist Section -->
            <div class="package-section">
                <div class="container">
                    <div class="package-inner">
                        <div class="row">
                            <% if (packages.length === 0) { %>
                                <div class="col-12 text-center">
                                    <h3>Your Wishlist is Empty</h3>
                                    <p>Add some exciting tour packages to your wishlist!</p>
                                    <a href="/tour-packages" class="button-text">Explore Packages</a>
                                </div>
                            <% } else { %>
                                <% packages.forEach(function(package) { %>
                                    <div class="col-lg-4 col-md-6">
                                        <div class="package-wrap">
                                            <figure class="feature-image">
                                                <a href="/package-detail/<%= package._id %>">
                                                    <img src="/Uploads/gallery/<%= package.featuredImage || 'default.jpg' %>" alt="<%= package.title %>">
                                                </a>
                                            </figure>
                                            <div class="package-price">
                                                <h6>
                                                    <span>$<%= package.salePrice || package.regularPrice %></span> / per person
                                                </h6>
                                            </div>
                                            <div class="package-content-wrap">
                                                <div class="package-meta text-center">
                                                    <ul>
                                                        <li>
                                                            <i class="far fa-clock"></i>
                                                            <%= package.tripDuration.days %>D/<%= package.tripDuration.nights %>N
                                                        </li>
                                                        <li>
                                                            <i class="fas fa-user-friends"></i>
                                                            People: <%= package.groupSize || 'N/A' %>
                                                        </li>
                                                        <li>
                                                            <i class="fas fa-map-marker-alt"></i>
                                                            <%= package.destinationCountry || 'N/A' %>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="package-content">
                                                    <h3>
                                                        <a href="/package-detail/<%= package._id %>"><%= package.title %></a>
                                                    </h3>
                                                    <div class="review-area">
                                                        <span class="review-text">(<%= package.reviewCount || 0 %> reviews)</span>
                                                        <div class="rating-start" title="Rated <%= package.averageRating || 0 %> out of 5">
                                                            <% for (let i = 1; i <= 5; i++) { %>
                                                                <i class="fas fa-star <%= i <= Math.round(package.averageRating || 0) ? 'filled' : '' %>"></i>
                                                            <% } %>
                                                        </div>
                                                    </div>
                                                    <p><%= package.description?.substring(0, 100) %>...</p>
                                                    <div class="btn-wrap">
                                                        <a href="/booking/<%= package._id %>" class="button-text width-6">Book Now<i class="fas fa-arrow-right"></i></a>
                                                        <a href="#" class="wishlist-remove button-text width-6" data-package-id="<%= package._id %>">Remove<i class="fas fa-trash"></i></a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% }) %>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <%- include('../partials/Footer.ejs') %>
    </div>

    <%- include('../../shared/partials/toaster') %>

    <%- include('../partials/Script.ejs') %>
    <!-- Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Handle wishlist removal
            document.querySelectorAll('.wishlist-remove').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const packageId = button.getAttribute('data-package-id');

                    try {
                        const response = await fetch(`/wishlist/remove/${packageId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        });
                        const data = await response.json();

                        if (response.ok) {
                            window.location.reload()
                            button.closest('.col-lg-4').remove();
                            if (document.querySelectorAll('.package-wrap').length === 0) {
                                document.querySelector('.package-inner .row').innerHTML = `
                                    <div class="col-12 text-center">
                                        <h3>Your Wishlist is Empty</h3>
                                        <p>Add some exciting tour packages to your wishlist!</p>
                                        <a href="/tour-packages" class="button-text">Explore Packages</a>
                                    </div>
                                `;
                            }
                   
                        } else {
                            alert('Failed to remove package from wishlist');
                        }
                    } catch (error) {
                        console.error('Error removing from wishlist:', error);
                        alert('Error removing package from wishlist');
                    }
                });
            });
        });
    </script>
</body>
</html>