
<!DOCTYPE html>
<html lang="en">
<%- include('../partials/Header')%>
<body>
    <%- include('../partials/Loader')%>
    <div id="page" class="full-page">
        <%- include('../partials/Navbar')%>
        <main id="content" class="site-main">
            <section class="inner-banner-wrap">
                <div class="inner-baner-container" style="background-image: url(/assets/images/inner-banner.jpg);">
                    <div class="container">
                        <div class="inner-banner-content">
                            <h1 class="inner-title">Package Cart</h1>
                        </div>
                    </div>
                </div>
                <div class="inner-shape"></div>
            </section>
            <div class="step-section cart-section">
                <div class="container">
                    <div class="step-link-wrap">
                        <div class="step-item active">
                            Your cart
                            <a href="#" class="step-icon"></a>
                        </div>
                        <div class="step-item">
                            Your Details
                            <a href="#" class="step-icon"></a>
                        </div>
                        <div class="step-item">
                            Finish
                            <a href="#" class="step-icon"></a>
                        </div>
                    </div>
                    <div class="cart-list-inner">
                        <form action="/packageCart/checkout" method="POST" id="cart-form">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>Product Name</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Sub Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (cart && cart.items.length > 0) { %>
                                            <% cart.items.forEach(item => { %>
                                                <tr data-package-id="<%= item.packageId._id %>">
                                                    <td>
                                                        <button class="close cart-remove" data-dismiss="alert" aria-label="Close" data-package-id="<%= item.packageId._id %>"><span aria-hidden="true">Ã—</span></button>
                                                        <span class="cartImage"><img src="<%= item.packageId.featuredImage ? '/Uploads/gallery/' + item.packageId.featuredImage : '/assets/images/default.jpg' %>" alt="image"></span>
                                                    </td>
                                                    <td data-column="Product Name"><%= item.packageId.title %></td>
                                                    <td data-column="Price" data-price="<%= item.packageId.salePrice || item.packageId.regularPrice %>">$<%= (item.packageId.salePrice || item.packageId.regularPrice).toFixed(2) %></td>
                                                    <td data-column="Quantity" class="count-input">
                                                        <div>
                                                            <a class="minus-btn cart-quantity-btn" href="#" data-package-id="<%= item.packageId._id %>"><i class="fa fa-minus"></i></a>
                                                            <input class="quantity" type="text" name="quantities[<%= item.packageId._id %>]" value="<%= item.quantity %>" data-package-id="<%= item.packageId._id %>">
                                                            <a class="plus-btn cart-quantity-btn" href="#" data-package-id="<%= item.packageId._id %>"><i class="fa fa-plus"></i></a>
                                                        </div>
                                                    </td>
                                                    <td data-column="Sub Total" class="sub-total">$<%= (item.quantity * (item.packageId.salePrice || item.packageId.regularPrice)).toFixed(2) %></td>
                                                </tr>
                                            <% }) %>
                                        <% } else { %>
                                            <tr>
                                                <td colspan="5">Your cart is empty.</td>
                                            </tr>
                                        <% } %>
                                    </tbody>
                                </table>
                            </div>
                            <div class="updateArea">
                                <!-- <div class="input-group">
                                    <input type="text" class="form-control" placeholder="I have a discount coupon">
                                    <a href="#" class="outline-primary">apply coupon</a>
                                </div>
                                <a href="#" class="outline-primary update-btn" id="update-cart">update cart</a> -->
                            </div>
                            <div class="totalAmountArea">
                                <ul class="list-unstyled">
                                    <li><strong>Sub Total</strong> <span class="sub-total-amount">$<%= cart && cart.items.length > 0 ? cart.items.reduce((sum, item) => sum + item.quantity * (item.packageId.salePrice || item.packageId.regularPrice), 0).toFixed(2) : '0.00' %></span></li>
                                    <li><strong>Vat</strong> <span class="vat-amount">$<%= cart && cart.items.length > 0 ? (cart.items.reduce((sum, item) => sum + item.quantity * (item.packageId.salePrice || item.packageId.regularPrice), 0) * 0.13).toFixed(2) : '0.00' %></span></li>
                                    <li><strong>Grand Total</strong> <span class="grand-total">$<%= cart && cart.items.length > 0 ? (cart.items.reduce((sum, item) => sum + item.quantity * (item.packageId.salePrice || item.packageId.regularPrice), 0) * 1.13).toFixed(2) : '0.00' %></span></li>
                                </ul>
                            </div>
                            <div class="checkBtnArea text-right">
                                <button type="submit" class="button-primary">Checkout</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
        <%- include('../partials/Footer')%>
    </div>

    <%- include('../../shared/partials/toaster') %>

    <!-- JavaScript -->
    <%- include('../partials/Script')%>
    <script>
        // Prevent duplicate script execution
        if (!window.cartScriptInitialized) {
            window.cartScriptInitialized = true;

            // Function to update totals in the frontend
            function updateTotals() {
                let subTotal = 0;
                document.querySelectorAll('tbody tr').forEach(row => {
                    const price = parseFloat(row.querySelector('[data-column="Price"]').getAttribute('data-price')) || 0;
                    const quantity = parseInt(row.querySelector('.quantity').value) || 0;
                    const rowSubTotal = price * quantity;
                    row.querySelector('.sub-total').textContent = `$${rowSubTotal.toFixed(2)}`;
                    subTotal += rowSubTotal;
                });

                const vat = subTotal * 0.13;
                const grandTotal = subTotal + vat;

                document.querySelector('.sub-total-amount').textContent = `$${subTotal.toFixed(2)}`;
                document.querySelector('.vat-amount').textContent = `$${vat.toFixed(2)}`;
                document.querySelector('.grand-total').textContent = `$${grandTotal.toFixed(2)}`;
            }

            // Use event delegation to handle quantity updates
            document.querySelector('tbody').addEventListener('click', function(e) {
                if (!e.target.closest('.cart-quantity-btn')) return;
                e.preventDefault();
                e.stopPropagation();

                const button = e.target.closest('.cart-quantity-btn');
                const packageId = button.getAttribute('data-package-id');
                const row = button.closest('tr[data-package-id="' + packageId + '"]');
                const input = row.querySelector('.quantity');
                const originalQuantity = parseInt(input.value) || 0;
                let quantity = originalQuantity;

                if (button.classList.contains('minus-btn')) {
                    quantity = Math.max(1, quantity - 1);
                } else if (button.classList.contains('plus-btn')) {
                    quantity = quantity + 1;
                }

                input.value = quantity;

                // Update cart in backend
                fetch('/packageCart/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ packageId, quantity })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // window.location.reload()
                        updateTotals();
                    } else {
                        console.log('Error updating cart: ' + data.message);
                        input.value = originalQuantity;
                    }
                })
                .catch(error => {
                    console.error('Error updating cart:', error);
                    input.value = originalQuantity;
                });
            });

            // Use event delegation to handle remove item
            document.querySelector('tbody').addEventListener('click', function(e) {
                if (!e.target.closest('.cart-remove')) return;
                e.preventDefault();
                e.stopPropagation();

                const button = e.target.closest('.cart-remove');
                const packageId = button.getAttribute('data-package-id');

                fetch('/packageCart/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ packageId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload()
                        const row = document.querySelector(`tr[data-package-id="${packageId}"]`);
                        if (row) row.remove();
                        if (document.querySelectorAll('tbody tr').length > 0) {
                            updateTotals();
                        } else {
                            document.querySelector('tbody').innerHTML = '<tr><td colspan="5">Your cart is empty.</td></tr>';
                            document.querySelector('.sub-total-amount').textContent = '$0.00';
                            document.querySelector('.vat-amount').textContent = '$0.00';
                            document.querySelector('.grand-total').textContent = '$0.00';
                        }
                    } else {
                        console.log('Error removing item: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error removing item:', error);
                });
            });

  
        }
    </script>
</body>
</html>
